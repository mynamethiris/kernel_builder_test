name: Building Kernel

on:
  workflow_dispatch:
    inputs:
      clang-repo: { description: "Enter the URL for the Clang source", type: string }
      gcc64-repo: { description: "Enter URL for the GCC 64-bit source", type: string }
      gcc32-repo: { description: "Enter URL for the GCC 32-bit source", type: string }
      kernel-repo: { description: "Enter URL for the Kernel source", required: true, type: string }
      anykernel3-repo: { description: "Enter URL for the Anykernel3 source", type: string }
      toolchains-path: { description: "Enter the PATH for the Toolchains", required: true, type: string }
      more-flags: { description: "Enter additional build arguments", required: true, type: string }
      defconfig: { description: "Enter config file specific to your device", required: true, type: string }
      build-type: { description: "Enter Build Type for the build", required: true, default: "UNSTABLE", type: choice, options: ["STABLE", "UNSTABLE" ,"KERNELSU"] }
      ksu-setup-script: { description: "Enter URL for the KernelSU setup", type: string }

defaults:
  run:
    shell: bash

jobs:
  Build-and-Upload:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Repository
        id: checkout
        uses: actions/checkout@v4

      - name: Set Up Environment Variables for Build
        run: |
          {
            echo "USER=$GITHUB_ACTOR"
            echo "HOST=$(lsb_release -cs)"
            echo "TOOLCHAINS_PATH=tools"
            echo "CLANG_PATH=clang"
            echo "GCC_PATH=gcc"
            echo "GCC64_PATH=gcc64"
            echo "GCC32_PATH=gcc32"
            echo "KERNEL_PATH=kernel"
            echo "ANYKERNEL_PATH=zipper"
            echo "KERNEL_BOOT_PATH=/out/arch/arm64/boot"
            echo "IMAGE={Image.gz-dtb,Image-dtb,Image.gz,Image,dtbo.img}"
            echo "ZIP_NAME=${{ env.KERNEL_NAME }}-${{ env.LINUX_VERSION }}"
            echo "MSG_URL=https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage"
            echo "DOC_URL=https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendDocument"
          } >> $GITHUB_ENV

      - name: Get Toolchains
        id: get-toolchains
        run: |
          if [ -n "${{ inputs.clang-repo }}" ] && [ "${{ inputs.clang-repo }}" = "${{ inputs.gcc64-repo }}" ] && [ "${{ inputs.clang-repo }}" = "${{ inputs.gcc32-repo }}" ]; then
            echo "Clang, GCC64, and GCC32 URLs are the same, using tools path"
            TOOLCHAINS_REPO=${{ inputs.clang-repo }}
            git clone --depth=1 $TOOLCHAINS_REPO ${{ env.TOOLCHAINS_PATH }}
          elif [ -n "${{ inputs.clang-repo }}" ]; then
            echo "Clang URL detected"
            if [[ "${{ inputs.clang-repo }}" == *.tar.gz ]]; then
            echo "Clang Tarball detected"
              mkdir -p ${{ env.CLANG_PATH }}
              curl -RLO ${{ inputs.clang-repo }}
              tar -C ${{ env.CLANG_PATH }}/ -xf *.tar.gz
              rm -f *.tar.gz
            else
              echo "Clang Repo detected"
              git clone --depth=1 ${{ inputs.clang-repo }} ${{ env.CLANG_PATH }}
            fi
            if [ -n "${{ inputs.gcc64-repo }}" ] && [ -n "${{ inputs.gcc32-repo }}" ]; then
              echo "GCC 64-bit and GCC 32-bit URLs detected"
              if [ -n "${{ inputs.gcc64-repo }}" ] && [ "${{ inputs.gcc64-repo }}" = "${{ inputs.gcc32-repo }}" ]; then
                echo "GCC 64-bit and GCC 32-bit URLs are the same, using gcc path"
                GCC_REPO=${{ inputs.gcc64-repo }}
                git clone --depth=1 $GCC_REPO ${{ env.GCC_PATH }}
              else
                if [[ "${{ inputs.gcc64-repo }}" == *.tar.gz ]]; then
                  echo "GCC 64-bit Tarball detected"
                  mkdir -p ${{ env.GCC64_PATH }}
                  curl -RLO ${{ inputs.gcc64-repo }}
                  tar -C ${{ env.GCC64_PATH }}/ -xf *.tar.gz
                  rm -f *.tar.gz
                else
                  echo "GCC 64-bit Repo detected"
                  git clone --depth=1 ${{ inputs.gcc64-repo }} ${{ env.GCC64_PATH }}
                fi
              fi
              if [[ "${{ inputs.gcc32-repo }}" == *.tar.gz ]]; then
                echo "GCC 32-bit Tarball detected"
                mkdir -p ${{ env.GCC32_PATH }}
                curl -RLO ${{ inputs.gcc32-repo }}
                tar -C ${{ env.GCC32_PATH }}/ -xf *.tar.gz
                rm -f *.tar.gz
              else
                echo "GCC 32-bit Repo detected"
                git clone --depth=1 ${{ inputs.gcc32-repo }} ${{ env.GCC32_PATH }}
              fi
            fi
          elif [ -n "${{ inputs.gcc64-repo }}" ] && [ -n "${{ inputs.gcc32-repo }}" ]; then
            echo "GCC 64-bit and GCC 32-bit URLs detected"
            if [ -n "${{ inputs.gcc64-repo }}" ] && [ "${{ inputs.gcc64-repo }}" = "${{ inputs.gcc32-repo }}" ]; then
              echo "GCC 64-bit and GCC 32-bit URLs are the same, using gcc path"
              GCC_REPO=${{ inputs.gcc64-repo }}
              git clone --depth=1 $GCC_REPO ${{ env.GCC_PATH }}
            else
              if [[ "${{ inputs.gcc64-repo }}" == *.tar.gz ]]; then
                echo "GCC 64-bit Tarball detected"
                mkdir -p ${{ env.GCC64_PATH }}
                curl -RLO ${{ inputs.gcc64-repo }}
                tar -C ${{ env.GCC64_PATH }}/ -xf *.tar.gz
                rm -f *.tar.gz
              else
                echo "GCC 64-bit Repo detected"
                git clone --depth=1 ${{ inputs.gcc64-repo }} ${{ env.GCC64_PATH }}
              fi
            fi
            if [[ "${{ inputs.gcc32-repo }}" == *.tar.gz ]]; then
              echo "GCC 32-bit Tarball detected"
              mkdir -p ${{ env.GCC32_PATH }}
              curl -RLO ${{ inputs.gcc32-repo }}
              tar -C ${{ env.GCC32_PATH }}/ -xf *.tar.gz
              rm -f *.tar.gz
            else
              echo "GCC 32-bit Repo detected"
              git clone --depth=1 ${{ inputs.gcc32-repo }} ${{ env.GCC32_PATH }}
            fi
          else
            echo "No URLs detected"
            exit 1
          fi

      - name: Check Versions
        id: check-versions
        run: |
          if [ -n "${{ inputs.clang-repo }}" ]; then
            ${{ env.CLANG_PATH }}/clang --version
          fi
          if [ -n "${{ inputs.gcc64-repo }}" ]; then
            ${{ env.GCC64_PATH }}/gcc --version
          fi
          if [ -n "${{ inputs.gcc32-repo }}" ]; then
            ${{ env.GCC32_PATH }}/gcc --version
          fi

      - name: Clone Kernel Source
        id: clone-kernel
        run: |
          if [ -n "${{ inputs.kernel-repo }}" ]; then
            echo "Kernel Repo detected"
            git clone --depth=1 ${{ inputs.kernel-repo }} ${{ env.KERNEL_PATH }}
          else
            echo "No Kernel Repo detected"
            exit 1
          fi

      - name: Install KernelSU (if build type is KernelSU)
        id: install-ksu
        if: ${{ inputs.build-type == 'KERNELSU' }}
        run: |
          cd "${{ env.KERNEL_PATH }}"
          if [ -f ".gitmodules" ]; then
            if grep -q '\b.*KernelSU.*\b' ".gitmodules"; then
              echo "KernelSU submodule detected"
              git submodule update --init --recursive
            else
              echo "No KernelSU submodule detected"
            fi
          elif [ -n "${{ inputs.ksu-setup-script }}" ]; then
            echo "KernelSU setup script detected"
            "${{ inputs.ksu-setup-script }}"
          else
            echo "No KernelSU submodule or setup script detected, skipping KernelSU build"
          fi

      - name: Get Kernel Information
        id: get-info
        run: |
          cd "${{ env.KERNEL_PATH }}"
          {
            echo "KERNEL_NAME=$(grep -oP 'CONFIG_LOCALVERSION=\K.*' arch/arm64/configs/${{ inputs.defconfig }} | tr -d '"' | sed 's/^-//' | tr -d '\r\n' || echo "perf")"
            echo "LINUX_VERSION=$(make kernelversion)"
            echo "LATEST_COMMIT=$(git rev-parse --short HEAD)"
            echo "BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)"
            echo "BUILD_TYPE=${{ inputs.build-type }}"
            echo "BUILD_DIFF=$((BUILD_END - BUILD_START))"
          } >> $GITHUB_ENV

      - name: Clean Up the Kernel
        id: clean-kernel
        run: |
          cd "${{ env.KERNEL_PATH }}"
          make O=out clean
          make O=out mrproper

      - name: Compile the Kernel
        id: compile-kernel
        run: |
          cd "${{ env.KERNEL_PATH }}"
          BUILD_START="$(TZ=Asia/Jakarta date +"%s")"
          export KBUILD_BUILD_USER="${{ env.USER }}"
          export KBUILD_BUILD_HOST="${{ env.HOST }}"
          export PATH="${{ inputs.toolchains-path }}:${PATH}"

          make O=out ARCH=arm64 ${{ inputs.defconfig }}
          make O=out -j$(nproc --all) ${{ inputs.more-flags }} 2>&1 | tee build.log
          BUILD_END="$(TZ=Asia/Jakarta date +"%s")"

      - name: Zip the Compiled Kernel
        id: zip-kernel
        if: -n "${{ inputs.anykernel3-repo }}"
        run: |
          git clone --depth=1 ${{ inputs.anykernel3-repo }} "${{ env.ANYKERNEL_PATH }}"
          rm -rf ${{ env.ANYKERNEL_PATH }}/.git ${{ env.ANYKERNEL_PATH }}/.github ${{ env.ANYKERNEL_PATH }}/LICENSE ${{ env.ANYKERNEL_PATH }}/README.md

          if [ -f "${{ env.KERNEL_PATH }}/${{ env.KERNEL_BOOT_PATH }}/${{ env.IMAGE }}" ]; then
            cp "${{ env.KERNEL_PATH }}/${{ env.KERNEL_BOOT_PATH }}/${{ env.IMAGE }}" "${{ env.ANYKERNEL_PATH }}/${{ env.IMAGE }}"
            zip -r9 "${{ env.ZIP_NAME }}".zip
            MD5_CHECK=$(md5sum "${{ env.ZIP_NAME }}.zip" | cut -d' ' -f1)
          else
            echo "${{ env.IMAGE }} not found"
            exit 1
          fi

      - name: Notify to Telegram if Build Successful
        id: upload-and-notify-if-success
        if: success()
        run: |
          if [ -f "${{ env.ANYKERNEL_PATH }}/${{ env.ZIP_NAME }}.zip" ]; then
            curl -s -X POST -F document=@"${{ env.ANYKERNEL_PATH }}/${{ env.ZIP_NAME }}.zip" "${{ env.DOC_URL }}" \
            -F chat_id="${{ secrets.TELEGRAM_TO }}" \
            $(if [ -n "${{ secrets.TOPIC_ID }}" ]; then echo "-d \"message_thread_id=${{ secrets.TOPIC_ID }}\""; fi) \
            -F parse_mode="Markdown" \
            -F disable_web_page_preview="true" \
            -F caption="✅ Build Successful!
                        Kernel Name: ${{ env.KERNEL_NAME }}
                        Linux Version: ${{ env.LINUX_VERSION }}
                        Latest Commit: ${{ env.LATEST_COMMIT }}
                        Build Type: ${{ env.BUILD_TYPE }}
                        Build Time: ${{ env.BUILD_DIFF }}
                        MD5: ${{ env.MD5_CHECK }}" > /dev/null
          elif [ -f "${{ env.KERNEL_PATH }}/${{ env.KERNEL_BOOT_PATH }}/${{ env.IMAGE }}" ]; then
            MD5_CHECK=$(md5sum "${{ env.KERNEL_PATH }}/${{ env.KERNEL_BOOT_PATH }}/${{ env.IMAGE }}" | cut -d  -f1)
            curl -s -X POST -F document=@"${{ env.ANYKERNEL_PATH }}/${{ env.ZIP_NAME }}.zip" "${{ env.DOC_URL }}" \
            -F chat_id="${{ secrets.TELEGRAM_TO }}" \
            $(if [ -n "${{ secrets.TOPIC_ID }}" ]; then echo "-d \"message_thread_id=${{ secrets.TOPIC_ID }}\""; fi) \
            -F parse_mode="Markdown" \
            -F disable_web_page_preview="true" \
            -F caption="✅ Build Successful but Zip file not found!
                        Kernel Name: ${{ env.KERNEL_NAME }}
                        Linux Version: ${{ env.LINUX_VERSION }}
                        Latest Commit: ${{ env.LATEST_COMMIT }}
                        Build Type: ${{ env.BUILD_TYPE }}
                        Build Time: ${{ env.BUILD_DIFF }}
                        MD5: ${{ env.MD5_CHECK }}" > /dev/null
          else
            echo "No Zip file or Image found"
            exit 1
          fi

      - name: Notify to Telegram if Build Failed
        id: upload-and-notify-if-failed
        if: failure() || cancelled()
        run: |
          if [ "${{ job.status }}" = "failure" ]; then
            JOB_STATUS="Failed"
          elif [ "${{ job.status }}" = "cancelled" ]; then
            JOB_STATUS="Cancelled"
          fi

          if [ -f "${{ env.KERNEL_PATH }}/build.log" ]; then
            curl -s -X POST "${{ env.DOC_URL }}" \
            -F chat_id="${{ secrets.TELEGRAM_TO }}" \
            $(if [ -n "${{ secrets.TOPIC_ID }}" ]; then echo "-d \"message_thread_id=${{ secrets.TOPIC_ID }}\""; fi) \
            -F document=@"${{ env.KERNEL_PATH }}/build.log" \
            -F parse_mode="Markdown" \
            -F disable_web_page_preview="true" \
            -F caption="❌ Build $JOB_STATUS!
                        Kernel Name: ${{ env.KERNEL_NAME }}
                        Linux Version: ${{ env.LINUX_VERSION }}
                        Latest Commit: ${{ env.LATEST_COMMIT }}
                        Build Type: ${{ env.BUILD_TYPE }}
                        Build Time: ${{ env.BUILD_DIFF }}" > /dev/null
          else
            curl -s -X POST "${{ env.MSG_URL }}" \
            -d chat_id="${{ secrets.TELEGRAM_TO }}" \
            $(if [ -n "${{ secrets.TOPIC_ID }}" ]; then echo "-d \"message_thread_id=${{ secrets.TOPIC_ID }}\""; fi) \
            -d parse_mode="Markdown" \
            -d disable_web_page_view="true" \
            -d text="❌ Build $JOB_STATUS!
                        Kernel Name: ${{ env.KERNEL_NAME }}
                        Linux Version: ${{ env.LINUX_VERSION }}
                        Latest Commit: ${{ env.LATEST_COMMIT }}
                        Build Type: ${{ env.BUILD_TYPE }}
                        Build Time: ${{ env.BUILD_DIFF }}" > /dev/null
          fi

      - name: Upload Kernel to Artifact
        id: upload-artifact
        if: github.secrets.TELEGRAM_TO == '' || github.secrets.TELEGRAM_TOKEN == '' || github.secrets.TOPIC_ID == '' || !startsWith(github.secrets.TELEGRAM_TO, '-100')
        uses: actions/upload-artifact@v4
        with: 
          name: ${{ env.KERNEL_NAME }}-${{ env.KERNEL_VERSION }}-${{ env.BUILD_TYPE }}
          path: ${{ env.ANYKERNEL_PATH }}/*
